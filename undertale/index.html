<!DOCTYPE html>
<html lang="en-us">
  <head>
    <base href="https://cdn.jsdelivr.net/gh/arcade-v/gamemaker/undertale/"> 
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
    <link rel="icon" type="x-icon" href="favicon.png">
    <title>UNDERTALE</title>
    <style>
      @keyframes rotation {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: black;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        place-items: center;
        overflow: hidden;
      }

      body.scrollingDisabled { overflow: hidden; }

      .emscripten {
        display: block;
        text-align: center;
        font-family: "Lucida Console", Monaco, monospace;
      }

      canvas.emscripten {
        display: block;
        background-color: black;
        transition: opacity 0.5s ease-in;
        opacity: 0;
        image-rendering: pixelated;
      }

      canvas.active { opacity: 1; }
      canvas.paused { filter: blur(2px) grayscale(1); }
      canvas.unpaused { filter: none; }
      canvas.animatedSizeTransitions { transition: width 0.3s ease, height 0.3s ease; }

      .spinner {
        height: 30px;
        width: 30px;
        animation: rotation 0.8s linear infinite;
        border: 5px solid #bdff00;
        border-top: 5px solid #719900;
        border-radius: 50%;
      }

      #status { color: white; font-weight: bold; }
      progress[value]::-webkit-progress-bar { background-color: #8492a6; border-radius: 15px; }
      progress[value]::-webkit-progress-value { background-image: -webkit-linear-gradient(left, #719900, #bdff00); border-radius: 15px; }

      div.loading {
        position: absolute; top:0; bottom:0; left:0; right:0;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
      }

      #pauseMenuContainer {
        position: absolute; top:0; bottom:0; left:0; right:0;
        display: flex; justify-content:center; align-items:center;
      }
      #pauseMenuContainer[hidden] { display: none !important; }

      #pauseMenuBorder {
        background: linear-gradient(135deg, #FA1E4E, transparent 40%);
        padding: 1px; border-radius: 4px;
        clip-path: polygon(10.5px 0, 100% 0, 100% 100%, 0 100%, 0 10.5px);
        width: 70vw; max-width: 400px;
      }

      #pauseMenu {
        display:flex; flex-direction:column;
        padding: 60px 30px;
        background: linear-gradient(180deg, #2E273F 16.15%, rgba(46,39,63,0.79) 56.25%, #2E273F 91.15%);
        border-radius: 4px;
      }

      #pauseMenu button {
        font-weight: 500; font-size: 17px; color: white;
        background: #FA1E4E; border: 1px solid #FA1E4E; border-radius: 6px;
        padding: 12px 24px; margin: 5px 0; user-select: none;
      }
      #pauseMenu button#quitButton { background: #FA1E4E40; }
      #pauseMenu button:hover { filter: brightness(1.15); }
      #pauseMenu button:active { filter: brightness(0.85); }
    </style>
  </head>
  <body>
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>

    <div id="pauseMenuContainer" hidden>
      <div id="pauseMenuBorder">
        <div id="pauseMenu">
          <button id="resumeButton" onclick="resume()">Resume</button>
          <button id="quitButton" onclick="quitIfSupported()">Quit</button>
        </div>
      </div>
    </div>

    <div class="loading">
      <div class="spinner" id="spinner"></div>
      <div class="emscripten" id="status">Downloading...</div>
      <progress value="0" max="100" id="progress" hidden></progress>
    </div>

    <div id="message-container"><div id="messages"></div></div>

    <script>
      const canvas = document.getElementById('canvas');

function resizeCanvas() {
  const w = window.innerWidth;
  const h = window.innerHeight;
  const targetRatio = 4/3;

  let newWidth, newHeight;

  if (w / h > targetRatio) {
    // Window is wider than 4:3
    newHeight = h;
    newWidth = h * targetRatio;
  } else {
    // Window is taller than 4:3
    newWidth = w;
    newHeight = w / targetRatio;
  }

  // Round to integers to prevent blurry rendering
  newWidth = Math.floor(newWidth);
  newHeight = Math.floor(newHeight);

  canvas.style.width = newWidth + 'px';
  canvas.style.height = newHeight + 'px';
  canvas.style.position = 'absolute';
  canvas.style.left = Math.floor((w - newWidth) / 2) + 'px';
  canvas.style.top = Math.floor((h - newHeight) / 2) + 'px';

  // Only set the internal canvas resolution if different from current
  if (canvas.width !== newWidth || canvas.height !== newHeight) {
    canvas.width = newWidth;
    canvas.height = newHeight;
  }
}


      window.addEventListener('resize', resizeCanvas);
      document.addEventListener('fullscreenchange', resizeCanvas);
      resizeCanvas();

      function mergeFiles(fileParts) {
        return new Promise((resolve,reject)=>{
          let buffers=[];
          function fetchPart(i){
            if(i>=fileParts.length){
              resolve(URL.createObjectURL(new Blob(buffers)));
              return;
            }
            fetch(fileParts[i]).then(r=>r.arrayBuffer()).then(d=>{buffers.push(d); fetchPart(i+1)}).catch(reject);
          }
          fetchPart(0);
        });
      }

      function getParts(file,start,end){
        let parts=[];
        for(let i=start;i<=end;i++) parts.push(file+".part"+i);
        return parts;
      }

      mergeFiles(getParts("game.unx",1,7)).then(url=>{
        window.gameUnxUrl=url;

        const origFetch = window.fetch;
        window.fetch=async function(...args){
          let [url,opt]=args;
          if(typeof url==='string' && url.includes("game.unx")) url=window.gameUnxUrl;
          else if(url instanceof Request && url.url.includes("game.unx")) url=new Request(window.gameUnxUrl,url);
          return origFetch.call(this,url,opt);
        }

        const origOpen=XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open=function(method,url,...rest){
          if(url.includes("game.unx")) url=window.gameUnxUrl;
          return origOpen.call(this,method,url,...rest);
        }

        let index=document.createElement("script");
        index.src="index.js";
        document.body.appendChild(index);

        let runner=document.createElement("script");
        runner.src="runner.js";
        document.body.appendChild(runner);
      }).catch(e=>console.error("Failed to merge files:",e));
    </script>
  </body>
</html>
